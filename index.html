<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IPP — Inventaire Psychologique de Performance (Adultes)</title>
<link rel="stylesheet" href="print_header.css">
<style>
:root{--ink:#0f172a;--line:#e5e7eb;--muted:#475569}
*{box-sizing:border-box}html,body{margin:0;background:#fff;color:var(--ink);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial}
header.hero{display:flex;flex-direction:column;align-items:center;gap:14px;padding:28px 12px;background:#fff;border-bottom:1px solid var(--line)}
.logo{width:540px;max-width:92vw;height:auto;object-fit:contain;display:block}
.subtitle{color:var(--muted)}.rules{max-width:980px}
.rules ul{margin:8px 0 0 0;padding-left:18px;color:#334155;line-height:1.6}
.cta{background:var(--ink);color:#fff;border:1px solid var(--ink);border-radius:10px;padding:12px 18px;cursor:pointer}
.hidden{display:none}main{max-width:1200px;margin:18px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
.answers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.option{border:1px solid #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px;cursor:pointer;position:relative}
.option.selected{border-color:#2563eb;background:#eff6ff}
.rank-badge{position:absolute;top:8px;right:8px;background:#2563eb;color:#fff;border-radius:999px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700}
.nav{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}.nav .info{margin-left:auto;color:#475569}
.primary{background:var(--ink);color:#fff;border:1px solid var(--ink);border-radius:10px;padding:8px 12px}
.grid2{display:grid;grid-template-columns:1.1fr 0.9fr;gap:14px}.center{text-align:center}
#resultTable{width:100%;border-collapse:collapse;font-size:14px}#resultTable th,#resultTable td{border:1px solid #e2e8f0;padding:8px 10px;text-align:left;vertical-align:top}
#resultTable th:nth-child(2),#resultTable td:nth-child(2){text-align:right;width:70px}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}.kpi .b{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:8px}
@page { size: A4; margin: 12mm; }.like-a4{width:794px;min-height:1123px;margin:0 auto 16px auto;padding:18px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
#pgNarratif h3{margin:18px 0 6px}#pgNarratif p{line-height:1.6;margin:6px 0}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}footer{padding:12px;text-align:center;color:#64748b}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e293b;font-size:12px;margin-left:6px}
blockquote{background:#f8fafc;border-left:4px solid #94a3b8;margin:8px 0;padding:8px 10px;border-radius:6px}
ul{padding-left:18px}.dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
.dot.garant{background:#1f77b4}.dot.conq{background:#d62728}.dot.bienv{background:#2ca02c}.dot.fiable{background:#6b21a8}.dot.vision{background:#0284c7}.dot.spont{background:#f59e0b}
.legend{display:flex;gap:14px;justify-content:center;margin:6px 0 12px;font-size:14px}hr.sep{border:0;border-top:1px solid #e2e8f0;margin:10px 0}
.small{font-size:12px;color:#475569;text-align:center;margin-top:6px}
@media print{ header.hero, .toolbar button, #quiz { display: none !important; } body{ background:#fff } .like-a4{ page-break-after:always; box-shadow:none; border:0 } }
</style>
</head>
<body>
<div class="print-header">
  <img src="logo_entreprise.jpg" alt="Logo Académie de Performances"/>
  <div class="title-block">
    <h1 class="title">Inventaire Psychologique de Performances — Rapport</h1>
    <div class="subtitle">IPP (Version Adultes) • Export PDF</div>
  </div>
</div>

<header class="hero">
  <img class="logo" alt="Académie de Performances — Alexandre Griffet" src="logo_entreprise.jpg">
  <h1>Test IPP — Inventaire Psychologique de Performance (Adultes)</h1>
  <p class="subtitle">Travail • Sport • Famille • Relations</p>
  <button id="startBtn" class="cta">Commencer</button>
  <div class="rules"><ul>
    <li>Moment calme, sans dérangement.</li>
    <li>Répondez avec spontanéité — ne suranalysez pas.</li>
    <li>À chaque question, classez <b>3 à 6</b> propositions (1→6).</li>
    <li>Durée : jusqu’à 45 minutes.</li>
  </ul></div>
</header>

<main id="app" class="hidden">
  <section id="quiz" class="card"></section>
  <section id="report" class="card hidden">
    <div class="toolbar">
      <h2 style="margin:0">Votre rapport IPP <span id="badgeADN" class="badge"></span><span id="badgeCAP" class="badge"></span></h2>
      <div><button id="print" class="primary">Exporter PDF</button></div>
    </div>

    <div class="page like-a4" id="pg1">
      <h3 class="center">Étoile IPP — ❤️ ADN (100%) • ⭐ Cap (actuel) • ⚪ Caps vécus</h3>
      <div class="legend">
        <span><span class="dot garant"></span> Garant</span>
        <span><span class="dot conq"></span> Conquérant</span>
        <span><span class="dot bienv"></span> Bienveillant</span>
        <span><span class="dot fiable"></span> Fiable</span>
        <span><span class="dot vision"></span> Visionnaire</span>
        <span><span class="dot spont"></span> Spontané</span>
      </div>
      <div class="grid2">
        <div>
          <canvas id="etoile" height="420"></canvas>
          <div class="small">Chaque point coloré = un profil. Le chiffre indique le % pour ce profil.</div>
        </div>
        <div>
          <div class="kpi">
            <div class="b"><strong>ADN :</strong> <span id="kpiADN"></span></div>
            <div class="b"><strong>Cap actuel :</strong> <span id="kpiCAP"></span></div>
            <div class="b"><strong>Caps vécus :</strong> <span id="kpiLived"></span></div>
          </div>
          <table id="resultTable"><thead><tr><th>Profil</th><th>%</th><th>Repère</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div class="page like-a4" id="pg2">
      <h3 class="center">Boussole (Seul ↔ Groupe • Interne ↔ Externe) & Pyramide</h3>
      <div class="grid2">
        <div>
          <canvas id="boussole" height="420"></canvas>
          <div class="small">Le point montre votre position moyenne : vers « seul/interne » ou « groupe/externe ».</div>
        </div>
        <div>
          <canvas id="pyramide" height="420"></canvas>
          <div class="small">Trois niveaux d’effort : confortable, défi, tension. Visez surtout « défi ».</div>
        </div>
      </div>
    </div>

    <div class="page like-a4" id="pgNarratif">
      <div id="welcome"></div><hr class="sep"/><div id="sections"></div>
    </div>
  </section>
</main>
<footer><small>© IPP — Académie de Performances</small></footer>

<script>
const PROFILES=["Garant","Conquérant","Bienveillant","Fiable","Visionnaire","Spontané"];
let QUESTIONS=[], REPORTS={};

fetch('questions.json').then(r=>r.json()).then(q=>{QUESTIONS=q;});
fetch('reports.json').then(r=>r.json()).then(j=>{REPORTS=j;});

const $=s=>document.querySelector(s);
document.getElementById('startBtn').onclick=function(){
  document.getElementById('app').classList.remove('hidden'); renderQ();
  window.scrollTo({top:document.querySelector('#app').offsetTop,behavior:'smooth'});
};
document.addEventListener('DOMContentLoaded',()=>{ const p=document.getElementById('print'); if(p) p.onclick=()=>window.print(); });

let answers=[], current=0;
function ensure(){ if(!answers[current]) answers[current]=[]; return answers[current]; }

function renderQ(){
  if(!QUESTIONS.length){ document.getElementById('quiz').innerHTML="<p>Chargement en cours…</p>"; setTimeout(renderQ,200); return; }
  const ranked=ensure(); const q=QUESTIONS[current]; const rankOf=i=>{const p=ranked.indexOf(i);return p===-1?null:p+1;};
  const opts=q.options.map((o,i)=>`<div class="option ${rankOf(i)?'selected':''}" data-i="${i}">${o.label}${rankOf(i)?`<span class="rank-badge">${rankOf(i)}</span>`:''}</div>`).join('');
  const nav=`<div class="nav"><button id="prev" ${current===0?'disabled':''}>Précédent</button><button id="next" ${(ranked.length<3||current===QUESTIONS.length-1)?'disabled':''}>Suivant</button><button id="finish" class="primary" ${(ranked.length<3||current!==QUESTIONS.length-1)?'disabled':''}>Terminer</button><span class="info">Question ${current+1}/${QUESTIONS.length} — Choix : ${ranked.length}</span></div>`;
  document.getElementById('quiz').innerHTML=`<h3>${q.prompt}</h3><div class="answers">${opts}</div><p>Classez <b>3 à 6</b> réponses. L’ordre = votre préférence.</p>${nav}`;
  document.querySelectorAll('.option').forEach(el=>{el.addEventListener('click',()=>{const i=+el.dataset.i;const p=ranked.indexOf(i); if(p===-1){ if(ranked.length<6) ranked.push(i);} else {ranked.splice(p,1);} renderQ(); });});
  document.getElementById('prev').onclick=function(){ if(current>0){current--;renderQ();} };
  document.getElementById('next').onclick=function(){ if(current<QUESTIONS.length-1 && ranked.length>=3){current++;renderQ();} };
  document.getElementById('finish').onclick=function(){ if(ranked.length>=3){const r=compute();renderReport(r);window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});} };
}

function compute(){
  const weights=[6,5,4,3,2,1], P=PROFILES;
  const score=Object.fromEntries(P.map(p=>[p,0])), rank1=Object.fromEntries(P.map(p=>[p,0])), top2=Object.fromEntries(P.map(p=>[p,0]));
  const Q=QUESTIONS.length;
  QUESTIONS.forEach((q,qi)=>{const ranked=answers[qi]||[]; ranked.forEach((opt,idx)=>{ const p=q.options[opt].profil; score[p]+=(q.weight||1)*(weights[idx]||0); if(idx===0) rank1[p]+=1; if(idx<=1) top2[p]+=1; }); });
  const ADN=Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];

  const startIdx=Math.max(0,Q-Math.max(20,Math.floor(Q/3)));
  const winScore=Object.fromEntries(P.map(p=>[p,0])), winTop2=Object.fromEntries(P.map(p=>[p,0])); const winLen=Q-startIdx;
  for(let qi=startIdx;qi<Q;qi++){ const ranked=answers[qi]||[]; ranked.forEach((opt,idx)=>{ const p=QUESTIONS[qi].options[opt].profil; winScore[p]+=(QUESTIONS[qi].weight||1)*(weights[idx]||0); if(idx<=1) winTop2[p]+=1; }); }
  let capCandidates=P.filter(p=>p!==ADN).map(p=>[p,winScore[p]]).sort((a,b)=>b[1]-a[1]); let CAP=null;
  if(capCandidates.length){ const [p1,v1]=capCandidates[0]; const v2=capCandidates[1]?.[1]||0;
    const condTop2=(winTop2[p1]/Math.max(1,winLen))>=0.30; const condDelta=(v2===0)?true:((v1-v2)/Math.max(1,v2)>=0.05);
    if(condTop2 && v1>0) CAP=p1;
  }

  const lived=P.filter(p=>p!==ADN && p!==CAP).map(function(p){
    const s=top2[p]/Q; const e=rank1[p]/Q; const meanProxy=(Q-top2[p])/(Q||1)*3; const stable=meanProxy<=2.8;
    const ok=(s>=0.35 || e>=0.15) && stable; return {p,ok,raw:score[p]};
  }).filter(x=>x.ok).sort((a,b)=>b.raw-a.raw).map(x=>x.p).slice(0,2);

  const ADNraw=Math.max(score[ADN],1); const perc=Object.fromEntries(P.map(p=>[p,Math.round((score[p]/ADNraw)*80)]));
  perc[ADN]=100; lived.forEach(p=>perc[p]=100); if(CAP) perc[CAP]=Math.max(60,Math.min(95,perc[CAP]));
  P.forEach(function(p){ if(p!==ADN && p!==CAP && !lived.includes(p)){ perc[p]=Math.min((CAP?perc[CAP]-1:95), perc[p]); } perc[p]=Math.max(0,Math.min(100,perc[p])); });
  return {ADN,CAP,lived,perc,score};
}

function narrativeFor(adn, cap){
  const key=adn+"|"+(cap||adn); const R=REPORTS[key];
  if(!R) return "<p>Votre narratif détaillé est en cours de chargement…</p>";
  let html="";
  (R.sections||[]).forEach(s=>{
    if(s.title) html+=`<h3>${s.title}</h3>`;
    if(s.body) s.body.forEach(p=>html+=`<p>${p}</p>`);
    if(s.list) html+=`<ul>${(s.list||[]).map(x=>`<li>${x}</li>`).join("")}</ul>`;
  });
  return html;
}

function renderReport(r){
  document.getElementById('report').classList.remove('hidden');
  document.getElementById('badgeADN').textContent='ADN : '+r.ADN; document.getElementById('badgeCAP').textContent='Cap actuel : '+(r.CAP||r.ADN);
  document.getElementById('kpiADN').textContent=r.ADN; document.getElementById('kpiCAP').textContent=r.CAP||'—'; document.getElementById('kpiLived').textContent=r.lived.length?r.lived.join(', '):'—';

  const tb=document.querySelector('#resultTable tbody'); tb.innerHTML='';
  PROFILES.forEach(function(p){ const rep=(p===r.ADN?'❤️':(p===r.CAP?'⭐':(r.lived.includes(p)?'⚪':''))); const tr=document.createElement('tr'); tr.innerHTML='<td>'+p+'</td><td>'+r.perc[p]+'%</td><td>'+rep+'</td>'; tb.appendChild(tr); });

  const vals = PROFILES.map(l=>r.perc[l]||0);
  const c1=document.querySelector('#etoile').getContext('2d'); if(window.drawRadarStar) drawRadarStar(c1, PROFILES, vals);
  const c2=document.querySelector('#boussole').getContext('2d'); if(window.drawCompass) drawCompass(c2, r.perc);
  const c3=document.querySelector('#pyramide').getContext('2d'); if(window.drawPyramid) drawPyramid(c3);

  document.getElementById('welcome').innerHTML = '<p><strong>ADN :</strong> '+r.ADN+' — <strong>Cap actuel :</strong> '+(r.CAP||'—')+' — <strong>Caps vécus :</strong> '+(r.lived.join(', ')||'—')+'</p>';
  document.getElementById('sections').innerHTML = narrativeFor(r.ADN, r.CAP||r.ADN);
}
</script>

<script src="visuals_patch.js"></script>
</body>
</html>
